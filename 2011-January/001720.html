<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Socketcan-users] Trying to use socketCan on an Ixxat PC-I	04/104
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/socketcan-users/2011-January/index.html" >
   <LINK REL="made" HREF="mailto:socketcan-users%40lists.berlios.de?Subject=Re%3A%20%5BSocketcan-users%5D%20Trying%20to%20use%20socketCan%20on%20an%20Ixxat%20PC-I%0A%0904/104&In-Reply-To=%3CAANLkTinwZCq2EV%2BebXPgu6vpE9pAy7Qh27NYVpz-NWSy%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="001719.html">
   <LINK REL="Next"  HREF="001724.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Socketcan-users] Trying to use socketCan on an Ixxat PC-I	04/104</H1>
    <B>Willy Lambert</B> 
    <A HREF="mailto:socketcan-users%40lists.berlios.de?Subject=Re%3A%20%5BSocketcan-users%5D%20Trying%20to%20use%20socketCan%20on%20an%20Ixxat%20PC-I%0A%0904/104&In-Reply-To=%3CAANLkTinwZCq2EV%2BebXPgu6vpE9pAy7Qh27NYVpz-NWSy%40mail.gmail.com%3E"
       TITLE="[Socketcan-users] Trying to use socketCan on an Ixxat PC-I	04/104">lambert.willy at gmail.com
       </A><BR>
    <I>Fri Jan 14 01:06:16 CET 2011</I>
    <P><UL>
        <LI>Previous message: <A HREF="001719.html">[Socketcan-users] Trying to use socketCan on an Ixxat PC-I	04/104
</A></li>
        <LI>Next message: <A HREF="001724.html">[Socketcan-users] Trying to use socketCan on an Ixxat PC-I	04/104
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1720">[ date ]</a>
              <a href="thread.html#1720">[ thread ]</a>
              <a href="subject.html#1720">[ subject ]</a>
              <a href="author.html#1720">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>2011/1/14 Willy Lambert &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/socketcan-users">lambert.willy at gmail.com</A>&gt;

&gt;<i>
</I>&gt;<i>
</I>&gt;<i> 2011/1/13 Willy Lambert &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/socketcan-users">lambert.willy at gmail.com</A>&gt;
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> 2011/1/13 Wolfgang Grandegger &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/socketcan-users">wg at grandegger.com</A>&gt;
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> On 01/13/2011 12:25 AM, Willy Lambert wrote:
</I>&gt;&gt;&gt;<i> &gt; 2011/1/12 Willy Lambert &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/socketcan-users">lambert.willy at gmail.com</A>&gt;
</I>&gt;&gt;&gt;<i> &gt;
</I>&gt;&gt;&gt;<i> &gt;&gt; Because after lots of tests of moving jumpers it ended in this config.
</I>&gt;&gt;&gt;<i> As I
</I>&gt;&gt;&gt;<i> &gt;&gt; don't have serial yet it should work no ? Anyway I'll change because
</I>&gt;&gt;&gt;<i> it is
</I>&gt;&gt;&gt;<i> &gt;&gt; not an accurate choice
</I>&gt;&gt;&gt;<i> &gt;&gt;
</I>&gt;&gt;&gt;<i> &gt;&gt; 2011/1/12 Wolfgang Grandegger &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/socketcan-users">wg at grandegger.com</A>&gt;
</I>&gt;&gt;&gt;<i> &gt;&gt;
</I>&gt;&gt;&gt;<i> &gt;&gt; Hi Willy,
</I>&gt;&gt;&gt;<i> &gt;&gt;&gt;
</I>&gt;&gt;&gt;<i> &gt;&gt;&gt; On 01/12/2011 01:55 AM, Willy Lambert wrote:
</I>&gt;&gt;&gt;<i> &gt;&gt;&gt;&gt; Hi all,
</I>&gt;&gt;&gt;<i> &gt;&gt;&gt;&gt;
</I>&gt;&gt;&gt;<i> &gt;&gt;&gt;&gt; for memory I have been trying to makes socketCan working on my Ixxat
</I>&gt;&gt;&gt;<i> &gt;&gt;&gt; board
</I>&gt;&gt;&gt;<i> &gt;&gt;&gt;&gt; for some time. It is stacked on a PC104 cpu module with a linux
</I>&gt;&gt;&gt;<i> debian
</I>&gt;&gt;&gt;<i> &gt;&gt;&gt;&gt; squeeze. After having a fully hardware configuration (a proper node
</I>&gt;&gt;&gt;<i> +
</I>&gt;&gt;&gt;<i> &gt;&gt;&gt; can
</I>&gt;&gt;&gt;<i> &gt;&gt;&gt;&gt; analyser) I tried Ixxat drivers and succeed after soldering a jumper
</I>&gt;&gt;&gt;<i> on
</I>&gt;&gt;&gt;<i> &gt;&gt;&gt; the
</I>&gt;&gt;&gt;<i> &gt;&gt;&gt;&gt; board and setting some BIOS values. After this I quickly tested a
</I>&gt;&gt;&gt;<i> &gt;&gt;&gt; socketCan
</I>&gt;&gt;&gt;<i> &gt;&gt;&gt;&gt; version from svn and it seems to works (at least interrupts were
</I>&gt;&gt;&gt;<i> &gt;&gt;&gt; triggered).
</I>&gt;&gt;&gt;<i> &gt;&gt;&gt;&gt;
</I>&gt;&gt;&gt;<i> &gt;&gt;&gt;&gt; Cleaning time arrived and I complety reinstall the linux with only
</I>&gt;&gt;&gt;<i> the
</I>&gt;&gt;&gt;<i> &gt;&gt;&gt;&gt; required kernel configuration. The choosed kernel is a 2.6.35.7.
</I>&gt;&gt;&gt;<i> &gt;&gt;&gt;&gt; My first question is : may I use kernel official sources of
</I>&gt;&gt;&gt;<i> socketCan ?
</I>&gt;&gt;&gt;<i> &gt;&gt;&gt; or
</I>&gt;&gt;&gt;<i> &gt;&gt;&gt;&gt; do I need to checkout something ?
</I>&gt;&gt;&gt;<i> &gt;&gt;&gt;&gt;
</I>&gt;&gt;&gt;<i> &gt;&gt;&gt;&gt; I activated theses options :
</I>&gt;&gt;&gt;<i> &gt;&gt;&gt;&gt;
</I>&gt;&gt;&gt;<i> &gt;&gt;&gt;&gt;&gt; [*] Networking Support --&gt;
</I>&gt;&gt;&gt;<i> &gt;&gt;&gt;&gt;&gt; --- [*] CAN bus subsystem support --&gt;
</I>&gt;&gt;&gt;<i> &gt;&gt;&gt;&gt;&gt; ----------[*] Raw Can Protocol (raw access with CAN-ID filtering)
</I>&gt;&gt;&gt;<i> &gt;&gt;&gt;&gt;&gt; ----------[*] Broadcast Manager CAN Protocol (with content
</I>&gt;&gt;&gt;<i> filtering)
</I>&gt;&gt;&gt;<i> &gt;&gt;&gt;&gt;&gt; ----------     CAN Device Drivers ---&gt;
</I>&gt;&gt;&gt;<i> &gt;&gt;&gt;&gt;&gt; ----------------- [*] Virtual Local CAN Interface (vcan)
</I>&gt;&gt;&gt;<i> &gt;&gt;&gt;&gt;&gt; ----------------- [*] Platform CAN drivers with Netlonk support
</I>&gt;&gt;&gt;<i> &gt;&gt;&gt;&gt;&gt; ----------------- [*] CAN bit-timing calculation
</I>&gt;&gt;&gt;<i> &gt;&gt;&gt;&gt;&gt; ----------------- [*] Philips/NXP SJA1000 devices --&gt;
</I>&gt;&gt;&gt;<i> &gt;&gt;&gt;&gt;&gt; -------------------------[M] ISA Bus based legacy SJA1000 driver
</I>&gt;&gt;&gt;<i> &gt;&gt;&gt;&gt;&gt;
</I>&gt;&gt;&gt;<i> &gt;&gt;&gt;&gt; All remark is welcome (espacially if I need to choose &quot;M&quot; instead of
</I>&gt;&gt;&gt;<i> &quot;*&quot;
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> If you select &quot;M&quot;, the drive will be built as module otherwise it's
</I>&gt;&gt;&gt;<i> statically linked into the kernel.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> &gt; Is this usable from the current 2.6.35.7 official Linux tree ? or do I
</I>&gt;&gt;&gt;<i> need
</I>&gt;&gt;&gt;<i> &gt; other sources ?
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Should be fine.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> &gt;&gt;&gt; I setup my can0 interface in the rc.local script :
</I>&gt;&gt;&gt;<i> &gt;&gt;&gt;&gt;
</I>&gt;&gt;&gt;<i> &gt;&gt;&gt;&gt;&gt; modprobe sja1000_isa irq=3 mem=0XD0000
</I>&gt;&gt;&gt;<i> &gt;&gt;&gt;
</I>&gt;&gt;&gt;<i> &gt;&gt;&gt; Why do you use irq=3 now. IIRC, it's used for the serial port. Why
</I>&gt;&gt;&gt;<i> not
</I>&gt;&gt;&gt;<i> &gt;&gt;&gt; irq=5?
</I>&gt;&gt;&gt;<i> &gt;&gt;&gt;
</I>&gt;&gt;&gt;<i> &gt;&gt;
</I>&gt;&gt;&gt;<i> &gt; same with irq5. I have the same problem with Ixxat drivers. so it's
</I>&gt;&gt;&gt;<i> again an
</I>&gt;&gt;&gt;<i> &gt; interrupt problem. Do I need to activate some option into the kernel ?
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> I'm a bit confused. What is the current status of using CAN on you
</I>&gt;&gt;&gt;<i> system. Does the BCI driver from IXXAT now work properly?
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> So am I :)
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I reinstalled Ixxat drivers and manage to find my a working state for both
</I>&gt;&gt;<i> Ixxat and SocketCan drivers. A missed a jumper positionning and had some
</I>&gt;&gt;<i> BIOS problems.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> In conclusion I have :
</I>&gt;&gt;<i> _ a proper HW wiring and 2nd node
</I>&gt;&gt;<i> _ a particular IRQ jumper working configuration on my board
</I>&gt;&gt;<i> _ a particuliar BIOS config with uncertainty about what option made things
</I>&gt;&gt;<i> working.
</I>&gt;&gt;<i> _ a brand new 2.6.35.7 system with only the few required kernel options to
</I>&gt;&gt;<i> made things working.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I will now test BIOS options one by one to check which are required,
</I>&gt;&gt;<i> change IRQs to test several configuration, test the second CAN controller
</I>&gt;&gt;<i> and set up a test case with canplayer. I will report this as soon as i
</I>&gt;&gt;<i> finished.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;<i> I am stuck with the test case setup, candump shows error messages when I
</I>&gt;<i> try a cansend. I already have tricks with extended or standard data frame
</I>&gt;<i> formats with Ixxat drivers. My motors seems to only accept standard frames.
</I>&gt;<i> Is there a way to configure this ?
</I>&gt;<i>
</I>&gt;<i> I booted my target with Ixxat driver and run my test cases to validate
</I>&gt;<i> everything is in order. (BIOS options, jumpers, IRQ, wiring). I only use one
</I>&gt;<i> controller on IRQ11 (as it is said as &quot;reserved&quot; in my CPU board IRQ
</I>&gt;<i> mapping)
</I>&gt;<i> I may run my motor and receive SDO from him, everything seems to be OK.
</I>&gt;<i>
</I>&gt;<i> Without changing anything except my init script which load can drivers (in
</I>&gt;<i> order to load socket can drivers instead of Ixxat ones), I rebooted my CPU.
</I>&gt;<i>
</I>&gt;<i> Here is the load script :
</I>&gt;<i>
</I>&gt;&gt;<i> modprobe sja1000_isa irq=11 mem=0xD0000
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> ip link set can0 type can bitrate 250000 restart-ms 1000
</I>&gt;&gt;<i> ifconfig can0 up
</I>&gt;&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Here is dmesg answer (which seems correc) :
</I>&gt;<i>
</I>&gt;&gt;<i> [    3.928467] sja1000_isa sja1000_isa.0: sja1000_isa device registered
</I>&gt;&gt;<i> (reg_base=0xc00d0000, irq=11)
</I>&gt;&gt;<i> [    3.928646] Legacy sja1000_isa driver for max. 8 devices registered
</I>&gt;&gt;<i> [    3.938877] sja1000_isa sja1000_isa.0: setting BTR0=0x01 BTR1=0x1c
</I>&gt;&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Here is ifconfig result :
</I>&gt;<i>
</I>&gt;&gt;<i> can0      Link encap:UNSPEC  HWaddr
</I>&gt;&gt;<i> 00-00-00-00-00-00-00-00-00-00-00-00-00-00-00-00
</I>&gt;&gt;<i>           UP RUNNING NOARP  MTU:16  Metric:1
</I>&gt;&gt;<i>           RX packets:2 errors:0 dropped:0 overruns:0 frame:0
</I>&gt;&gt;<i>           TX packets:0 errors:0 dropped:0 overruns:0 carrier:0
</I>&gt;&gt;<i>           collisions:0 lg file transmission:10
</I>&gt;&gt;<i>           RX bytes:16 (16.0 B)  TX bytes:0 (0.0 B)
</I>&gt;&gt;<i>           Interruption:11
</I>&gt;&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Here is /proc/iomem
</I>&gt;<i>
</I>&gt;&gt;<i> 00000000-00000fff : reserved
</I>&gt;&gt;<i> 00001000-0009fbff : System RAM
</I>&gt;&gt;<i> 0009fc00-0009ffff : reserved
</I>&gt;&gt;<i> 000a0000-000bffff : Video RAM area
</I>&gt;&gt;<i> 000c0000-000c7fff : Video ROM
</I>&gt;&gt;<i> 000d0000-000d001f : sja1000_isa
</I>&gt;&gt;<i> ...
</I>&gt;&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Here is /proc/interrupts
</I>&gt;<i>
</I>&gt;&gt;<i>            CPU0
</I>&gt;&gt;<i>   0:        215   IO-APIC-edge      timer
</I>&gt;&gt;<i>   1:          8   IO-APIC-edge      i8042
</I>&gt;&gt;<i>   2:          0    XT-PIC-XT        cascade
</I>&gt;&gt;<i>   8:         97   IO-APIC-edge      rtc0
</I>&gt;&gt;<i>  11:          1   IO-APIC-edge      can0
</I>&gt;&gt;<i>  12:          7   IO-APIC-edge      i8042
</I>&gt;&gt;<i>  14:          0   IO-APIC-edge      ata_piix
</I>&gt;&gt;<i>  15:       1017   IO-APIC-edge      ata_piix
</I>&gt;&gt;<i>  19:          0   IO-APIC-fasteoi   uhci_hcd:usb3
</I>&gt;&gt;<i>  23:         14   IO-APIC-fasteoi   ehci_hcd:usb1, uhci_hcd:usb2
</I>&gt;&gt;<i>  40:        411   PCI-MSI-edge      eth0
</I>&gt;&gt;<i> NMI:          0   Non-maskable interrupts
</I>&gt;&gt;<i> LOC:     293000   Local timer interrupts
</I>&gt;&gt;<i> SPU:          0   Spurious interrupts
</I>&gt;&gt;<i> PMI:          0   Performance monitoring interrupts
</I>&gt;&gt;<i> PND:          0   Performance pending work
</I>&gt;&gt;<i> TRM:          0   Thermal event interrupts
</I>&gt;&gt;<i> THR:          0   Threshold APIC interrupts
</I>&gt;&gt;<i> MCE:          0   Machine check exceptions
</I>&gt;&gt;<i> MCP:          1   Machine check polls
</I>&gt;&gt;<i> ERR:          0
</I>&gt;&gt;<i> MIS:          0
</I>&gt;&gt;<i>
</I>&gt;<i>
</I>&gt;<i> I write this command to wake up everybody :
</I>&gt;<i>
</I>&gt;&gt;<i> ./cansend can0 000#0100
</I>&gt;&gt;<i>
</I>&gt;<i>
</I>&gt;<i> And at the same time, in another terminal, I run candump with theses
</I>&gt;<i> results :
</I>&gt;<i>
</I>&gt;&gt;<i>  ./candump any,0:0,#FFFFFFFF
</I>&gt;&gt;<i>   can0  20000040  [8] 00 00 00 00 00 00 00 00   ERRORFRAME
</I>&gt;&gt;<i>   can0  20000100  [8] 00 00 00 00 00 00 00 00   ERRORFRAME
</I>&gt;&gt;<i>   can0  20000004  [8] 00 04 00 00 00 00 00 71   ERRORFRAME
</I>&gt;&gt;<i>   can0  20000004  [8] 00 10 00 00 00 00 00 81   ERRORFRAME
</I>&gt;&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Did I do something wrong ?
</I>&gt;<i>
</I>&gt;<i>
</I>
This simple program ended in the same candump reaction

&gt;<i> #include &lt;iostream&gt;
</I>&gt;<i> #include &lt;string.h&gt;
</I>&gt;<i>
</I>&gt;<i> //can
</I>&gt;<i> #include &lt;sys/types.h&gt;
</I>&gt;<i> #include &lt;sys/socket.h&gt;
</I>&gt;<i> #include &lt;sys/ioctl.h&gt;
</I>&gt;<i> #include &lt;net/if.h&gt;
</I>&gt;<i>
</I>&gt;<i> #include &lt;linux/can.h&gt;
</I>&gt;<i> #include &lt;linux/can/raw.h&gt;
</I>&gt;<i> #include &lt;string.h&gt;
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> using namespace std;
</I>&gt;<i>
</I>&gt;<i> int main()
</I>&gt;<i> {
</I>&gt;<i>     cout &lt;&lt; &quot;!!!Hello World!!!&quot; &lt;&lt; endl; // prints !!!Hello World!!!
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>    /* Create the socket */
</I>&gt;<i>    int skt = socket( PF_CAN, SOCK_RAW, CAN_RAW );
</I>&gt;<i>
</I>&gt;<i>    /* Locate the interface you wish to use */
</I>&gt;<i>    struct ifreq ifr;
</I>&gt;<i>    strcpy(ifr.ifr_name, &quot;can0&quot;);
</I>&gt;<i>    ioctl(skt, SIOCGIFINDEX, &amp;ifr); /* ifr.ifr_ifindex gets filled
</I>&gt;<i>                                   * with that device's index */
</I>&gt;<i>
</I>&gt;<i>    /* Select that CAN interface, and bind the socket to it. */
</I>&gt;<i>    struct sockaddr_can addr;
</I>&gt;<i>    addr.can_family = AF_CAN;
</I>&gt;<i>    addr.can_ifindex = ifr.ifr_ifindex;
</I>&gt;<i>    bind( skt, (struct sockaddr*)&amp;addr, sizeof(addr) );
</I>&gt;<i>
</I>&gt;<i>    /* Send a message to the CAN bus */
</I>&gt;<i>    struct can_frame frame;
</I>&gt;<i>    frame.can_id = 0x000;
</I>&gt;<i>    frame.data[0] = 0x01;
</I>&gt;<i>    frame.data[1] = 0;
</I>&gt;<i>    frame.data[2] = 0;
</I>&gt;<i>    frame.data[3] = 0;
</I>&gt;<i>    frame.data[4] = 0;
</I>&gt;<i>    frame.data[5] = 0;
</I>&gt;<i>    frame.data[6] = 0;
</I>&gt;<i>    frame.data[7] = 0;
</I>&gt;<i>    frame.can_dlc = 2;
</I>&gt;<i>    int bytes_sent = write( skt, &amp;frame, sizeof(frame) );
</I>&gt;<i>    cout &lt;&lt; &quot;byte sent : &quot; &lt;&lt; bytes_sent &lt;&lt; endl;
</I>&gt;<i>
</I>&gt;<i>    /* Read a message back from the CAN bus */
</I>&gt;<i>    int bytes_read = read( skt, &amp;frame, sizeof(frame) );
</I>&gt;<i>    cout &lt;&lt; &quot;byte read : &quot; &lt;&lt; bytes_read &lt;&lt; endl;
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>     return 0;
</I>&gt;<i> }
</I>&gt;<i>
</I>




&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Wolfgang.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;<i>
</I>-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="https://lists.berlios.de/pipermail/socketcan-users/attachments/20110114/d023e58e/attachment.html">https://lists.berlios.de/pipermail/socketcan-users/attachments/20110114/d023e58e/attachment.html</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="001719.html">[Socketcan-users] Trying to use socketCan on an Ixxat PC-I	04/104
</A></li>
	<LI>Next message: <A HREF="001724.html">[Socketcan-users] Trying to use socketCan on an Ixxat PC-I	04/104
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1720">[ date ]</a>
              <a href="thread.html#1720">[ thread ]</a>
              <a href="subject.html#1720">[ subject ]</a>
              <a href="author.html#1720">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/socketcan-users">More information about the Socketcan-users
mailing list</a><br>
</body></html>
